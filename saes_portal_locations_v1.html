<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SAES Production Flow — Grid Tiles (SSE)</title>
<style>
  :root{
    --panel:#ffffff; --muted:#64748b; --text:#0f172a; --ring:#94a3b8;
    --green:#16a34a; --red:#ef4444; --yellow:#f59e0b; --gray:#cbd5e1;
    --card:#f8fafc; --ink:#0f172a; --blue:#2563eb;
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#f1f5f9; color:#0f172a; }
  header{ padding:16px 24px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px; }
  .title{ font-size:18px; font-weight:700; display:flex; gap:10px; align-items:center; }
  .status{ display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #e2e8f0; background:#fff }
  .dot{ width:8px; height:8px; border-radius:50% }
  .dot.ok{ background:#10b981 } .dot.warn{ background:#f59e0b } .dot.bad{ background:#ef4444 }
  .muted{ color:#0f172a; font-size:12px; background:#e0f2fe; border:1px solid #bae6fd; padding:6px 8px; border-radius:8px }

  .wrap{ padding:0 24px 24px; }
  .tabs{ display:flex; gap:8px; margin:0 24px 8px; align-items:center; flex-wrap:wrap }
  .tab{ padding:8px 14px; border-radius:10px; border:1px solid #e2e8f0; background:#fff; cursor:pointer; font-size:14px }
  .tab.active{ background:#0f172a; color:#fff; border-color:#0f172a }
  .panel{ display:none } .panel.active{ display:block }
  .selbar{ display:flex; gap:8px; align-items:center; margin-left:auto }
  .toggle{ padding:8px 12px; border-radius:10px; border:1px solid #e2e8f0; background:#fff; cursor:pointer; font-size:13px }
  .toggle.on{ background:#1d4ed8; color:#fff; border-color:#1d4ed8 }
  .badge-sel{ background:#111827; color:#fff; border-radius:999px; padding:3px 8px; font-size:12px }
  .btn{ background:#0f172a; color:#fff; border:none; border-radius:10px; padding:6px 10px; font-size:12px; cursor:pointer }
  .btn.secondary{ background:#e2e8f0; color:#0f172a }
  .btn.muted{ background:#6b7280; color:#fff }   /* grey Clear Section */
  .btn.ok{ background:#10b981; color:#fff }
  .btn[disabled]{ opacity:.5; cursor:not-allowed }

  /* Color key */
  .keybar{ display:flex; gap:10px; align-items:center; margin:6px 24px 12px; flex-wrap:wrap }
  .keyitem{ display:flex; align-items:center; gap:6px; background:#fff; border:1px solid #e2e8f0; padding:6px 10px; border-radius:999px; font-size:12px }
  .sw{ width:14px; height:14px; border-radius:4px; border:1px solid #475569; background:#fff }
  .sw.red{ background:#ef4444 }
  .sw.green{ background:#22c55e }
  .sw.yellow{ background:#f59e0b }
  .sw.white{ background:#fff }

  /* Global Add Cards bar */
  .addbar{ display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; margin:8px 24px 12px; }
  .group{ display:flex; gap:6px; align-items:center; background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:8px; }
  .group label{ font-size:12px; color:#334155; }
  .group input, .group select{ border:1px solid #cbd5e1; border-radius:8px; padding:6px 8px; font-size:14px; background:#fff }
  .group input[type="number"]{ width:90px }
  .group select{ min-width:160px }
  .group .checkbox{ display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#334155 }

  .locations{ display:grid; gap:16px; grid-template-columns: 1fr; }
  @media (min-width: 1100px){
    .locations{ grid-template-columns: repeat(3,1fr); }
  }
  .location{ background:#fff; border:1px solid #e2e8f0; border-radius:16px; padding:16px; display:flex; flex-direction:column; gap:12px; }
  .loc-header{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
  .loc-title{ font-weight:700; font-size:16px }

  .loc-tools{ display:flex; align-items:center; gap:10px; }
  .thresh{ width:80px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:8px; font-size:13px; }
  .loc-ind{ padding:6px 12px; border-radius:999px; font-weight:800; font-size:13px; color:#fff; min-width:92px; text-align:center }
  .loc-ind.good{ background:#16a34a }
  .loc-ind.bad{ background:#ef4444 }
  .badge{ background:#0f172a; color:#fff; border-radius:999px; padding:2px 8px; font-size:12px }
  .small{ font-size:12px; color:#475569 }

  .sections{ display:flex; flex-direction:column; gap:12px; }
  .section{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:8px; }
  .section-header{ display:flex; align-items:center; justify-content:space-between; padding:6px 8px; background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; color:#0f172a; font-weight:600; }
  .section-title{ display:flex; align-items:center; gap:8px; }
  .section-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

  /* GRID LIST */
  .list{ display:grid; gap:6px; grid-template-columns: repeat(auto-fill, minmax(22px, 1fr)); min-height:28px }
  .tile{ width:22px; height:22px; border-radius:4px; border:1px solid #475569; background:#f8fafc; cursor:grab; user-select:none; position:relative; display:flex; align-items:center; justify-content:center; overflow:hidden; font-weight:700; line-height:1; font-size:10px; }
  .tile.ready{ background:#22c55e; }      /* Green = Stocked */
  .tile.issue{ background:#ef4444; }      /* Red = Issues */
  .tile.progress{ background:#facc15; }   /* Yellow = In Progress */
  .tile.empty{ background:#f8fafc; }      /* White = Unused */
  .tile.dragging{ opacity:.6 } .tile:active{ cursor:grabbing }
  .tile.selected{ outline:2px solid #2563eb; outline-offset:-1px; box-shadow:0 0 0 2px rgba(37,99,235,.25) inset }
  .tile .x{ display:none }
  .tile:hover .x{ display:block; position:absolute; right:-6px; top:-6px; background:#fff; border:1px solid #e2e8f0; border-radius:8px; font-size:10px; padding:0 3px; cursor:pointer }

  /* Charts */
  .charts{ display:flex; flex-direction:column; gap:16px }
  .charts-row{ display:flex; gap:16px; align-items:flex-start; }
  .charts-row.center{ justify-content:center; }
  .charts-row.line{ justify-content:flex-start; flex-wrap:nowrap; overflow-x:auto; padding-bottom:8px }
  .chart-card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:16px; }
  .chart-title{ font-weight:600; margin-bottom:8px }
  .chart-wrap{ display:flex; gap:12px; align-items:center; }
  canvas{ width:280px; height:280px; background:#fff; border-radius:12px; }
  .legend{ display:flex; flex-direction:column; gap:6px; min-width:160px }
  .legend-item{ display:flex; align-items:center; gap:8px; font-size:13px; color:#334155 }
  .legend-swatch{ width:12px; height:12px; border-radius:3px; display:inline-block }

  /* Issues tab */
  .issues{ display:flex; flex-direction:column; gap:10px; }
  .issues-header{ display:flex; gap:12px; align-items:center; margin:0 24px }
  .issues-total{ background:#fff; border:1px solid #e2e8f0; padding:6px 10px; border-radius:10px; font-weight:600 }
  .issues-table{ display:flex; flex-direction:column; gap:8px; margin:0 24px 8px; }
  .issues-row{ display:grid; grid-template-columns: 100px 120px 200px 1fr 110px; gap:10px; align-items:center; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px; }
  .issues-row.head{ background:transparent; border:none; font-weight:700; padding:0 10px; }
  .issue-note{ width:100%; border:1px solid #cbd5e1; border-radius:8px; padding:6px 8px; font-size:14px; background:#fff; }

  /* Log tab */
  .log{ display:flex; flex-direction:column; gap:10px; }
  .log-header{ display:flex; gap:10px; align-items:center; margin:0 24px }
  .log-header .btn{ padding:8px 12px }
  .log-table{ display:flex; flex-direction:column; gap:8px; margin:0 24px 8px; }
  .log-row{ display:grid; grid-template-columns: 120px 1fr 1fr 90px; gap:10px; align-items:center; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px; }
  .log-row.head{ background:transparent; border:none; font-weight:700; padding:0 10px; }
  .log-date{ font-weight:600; color:#0f172a; margin:12px 24px 0; }

  footer{ text-align:center; padding:16px; color:#64748b; font-size:12px }

    /* Marquee selection */
  #panel-board{ position:relative; }
  .marquee{ position:absolute; border:1px dashed #2563eb; background:rgba(37,99,235,.1); pointer-events:none; z-index:50; }

  /* SAES banner */
  .saes-banner{
    margin:8px 24px 0;
    background:#27B4F5;
    color:#011212;
    font-weight:900;
    letter-spacing:2px;
    font-size:32px;
    line-height:1;
    padding:12px 16px;
    border-radius:12px;
    text-align:center;
  }

</style>
</head>
<body>
  <header>
    <div class="title">
      SAES Production Flow — Grid Tiles
      <span class="status" id="netStatus"><span class="dot bad" id="dot"></span><span id="statusText">Offline</span></span>
    </div>
    <div class="muted">Realtime via <strong>SSE</strong>. Cards are created in the <strong>selected Location/Section</strong>. Multi-select by <strong>dragging</strong> (or use Select Mode).</div>
  </header>
</header>
<div class="saes-banner" role="banner" aria-label="SAES">SAES</div>

  <div class="tabs">
    <button class="tab active" data-tab="board">Board</button>
    <button class="tab" data-tab="charts">Charts</button>
    <button class="tab" data-tab="issues">Issues</button>
    <button class="tab" data-tab="log">Log</button>

    <div class="selbar">
  <button id="selectModeBtn" class="toggle">Select Mode</button>
  <span class="badge-sel" id="selCount">Selected: 0</span>
  <button id="clearSelBtn" class="btn secondary" disabled>Clear Selection</button>
  <button id="exportSnapshotBtn" class="btn secondary">Export Snapshot CSV</button>
</div>
  </div>

  <!-- Color key -->
  <div class="keybar">
  <div class="keyitem"><span class="sw red"></span> Red — Issues</div>
  <div class="keyitem"><span class="sw green"></span> Green — Stocked</div>
  <div class="keyitem"><span class="sw yellow"></span> Yellow — In Progress</div>
  <div class="keyitem"><span class="sw white"></span> White — Unused</div>
  <a class="btn" href="https://nitipull.onrender.com/" target="_blank" rel="noopener">Open NitiPull</a>
</div>

  <!-- Global Add Cards bar -->
  <div class="addbar" id="globalAddBar">
    <div class="group">
      <label>Add <strong>Card ID</strong> →</label>
      <select id="addLocSel"></select>
      <span>/</span>
      <select id="addSecSel"></select>
      <input id="addOneInput" type="number" placeholder="Card ID #" min="0" />
      <button id="addOneBtn" class="btn">Add</button>
    </div>
    <div class="group">
      <label>Batch:</label>
      <input id="batchStart" type="number" placeholder="Start" value="1" min="0" />
      <input id="batchEnd" type="number" placeholder="End" value="20" min="0" />
      <label class="checkbox"><input id="batchReady" type="checkbox" /><span>Mark Ready</span></label>
      <button id="batchBtn" class="btn">Add Range</button>
    </div>
  </div>

  <div class="wrap">
    <div id="panel-board" class="panel active">
      <div id="locations" class="locations"></div>
    </div>

    <div id="panel-charts" class="panel">
      <div class="charts">
        <div class="charts-row center">
          <div class="chart-card" id="wrap-locations">
            <div class="chart-title">Totals by Location</div>
            <div class="chart-wrap">
              <canvas id="chart-locations" width="280" height="280"></canvas>
              <div class="legend" id="legend-locations"></div>
            </div>
          </div>
        </div>
        <div class="charts-row line">
          <div class="chart-card" id="wrap-gs">
            <div class="chart-title">G&amp;S — Sections</div>
            <div class="chart-wrap">
              <canvas id="chart-gs" width="280" height="280"></canvas>
              <div class="legend" id="legend-gs"></div>
            </div>
          </div>
          <div class="chart-card" id="wrap-ferg">
            <div class="chart-title">Ferguson — Sections</div>
            <div class="chart-wrap">
              <canvas id="chart-ferg" width="280" height="280"></canvas>
              <div class="legend" id="legend-ferg"></div>
            </div>
          </div>
          <div class="chart-card" id="wrap-aba">
            <div class="chart-title">ABA — Sections</div>
            <div class="chart-wrap">
              <canvas id="chart-aba" width="280" height="280"></canvas>
              <div class="legend" id="legend-aba"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="panel-issues" class="panel">
      <div class="issues">
        <div class="issues-header">
          <div class="issues-total">Total Issues: <span id="issuesTotal">0</span></div>
        </div>
        <div class="issues-table" id="issuesTable">
          <div class="issues-row head">
            <div>Card ID</div><div>Location</div><div>Section</div><div>Issue</div><div></div>
          </div>
        </div>
      </div>
    </div>

    <div id="panel-log" class="panel">
      <div class="log">
        <div class="log-header">
          <button id="exportCsvBtn" class="btn secondary">Export CSV</button>
          <div class="small">Daily aggregated moves (From → To)</div>
        </div>
        <div class="log-table">
          <div class="log-row head">
            <div>Date</div><div>From</div><div>To</div><div>Count</div>
          </div>
          <div id="logBody"></div>
        </div>
      </div>
    </div>
  </div>

  <footer>© G&amp;S Bar &amp; Wire — SAES Board</footer>

<script>
(function(){
  /* ---------- SSE + State ---------- */
  const BASE = location.origin;
  let applyingRemote = false, saveTimer = null;
  function setStatus(text, level){
    document.getElementById('statusText').textContent = text;
    document.getElementById('dot').className = 'dot ' + (level||'bad');
  }
  async function saveRemote(){ if(applyingRemote) return; try{
    await fetch(BASE+'/patch',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({state})});
  }catch{} }
  function saveSoon(){ clearTimeout(saveTimer); saveTimer = setTimeout(saveRemote,120); }

  (function connect(){
    try{
      if (location.protocol.startsWith('http')) {
        const es = new EventSource(BASE+'/events');
        setStatus('Connecting…','warn');
        es.onmessage = ev => { try{
          const m=JSON.parse(ev.data||'{}');
          if(m && (m.type==='hello'||m.type==='patch') && m.state){
            applyingRemote=true; state=m.state; render(); applyingRemote=false; setStatus('Connected','ok');
          }
        }catch{} };
        es.onerror = ()=> setStatus('Offline','bad');
      } else {
        setStatus('Offline','bad');
      }
    }catch(e){ setStatus('Offline','bad'); }
  })();

  /* ---------- Config (NO AMD) ---------- */
  const CONFIG = [
    { id:'gs', title:'G&S', sections:[
      { id:'gsUnused', title:'SAES Unused' },
      { id:'coilConv',  title:'SAES Coil Conversion' },
      { id:'blast',     title:'SAES Shot Blast/Test' },
      { id:'p250HrcN15',  title:'SAES .250" HRC N15' },
      { id:'p250HrcN25',  title:'SAES .250" HRC N25' },
      { id:'p250AnnN15',  title:'SAES .250" Annealed N15' },
      { id:'p250AnnN25',  title:'SAES .250" Annealed N25' },
      { id:'p108HotN15',  title:'SAES .108" Hot Drawn N15' },
      { id:'p108HotN25',  title:'SAES .108" Hot Drawn N25' }
    ]},
    { id:'ferg', title:'Ferguson', sections:[
      { id:'fergUnusedN15',  title:'SAES Unused N15' },
      { id:'fergUnusedN25',  title:'SAES Unused N25' },
      { id:'ferg240AnnN15',  title:'SAES .240" Annealed N15' },
      { id:'ferg240AnnN25',  title:'SAES .240" Annealed N25' },
      { id:'ferg108HotN15',  title:'SAES .108" Hot Draw N15' },
      { id:'ferg108HotN25',  title:'SAES .108" Hot Draw N25' }
    ]},
    { id:'aba', title:'ABA', sections:[
      { id:'abaUnusedN15', title:'SAES Unused N15' },
      { id:'abaUnusedN25', title:'SAES Unused N25' },
      { id:'aba085N15',    title:'SAES .085" N15' },
      { id:'aba085N25',    title:'SAES .085" N25' }
    ]},
  ];

  /* Lookup maps */
  const LOC_TITLES = {}; const SEC_TITLES = {}; const SEC_TO_LOC = {};
  CONFIG.forEach(loc => {
    LOC_TITLES[loc.id] = loc.title;
    loc.sections.forEach(s => { SEC_TITLES[s.id]=s.title; SEC_TO_LOC[s.id]=loc.id; });
  });

  /* ---------- Initial State ---------- */
  function seed(){
    const cards = {};
    function add(sec, n, status='ready'){ const id = `${sec}-H${n}`; cards[id]={id,title:`Card ID ${n}`,status}; return id; }

    const sections = {}; CONFIG.forEach(l=>l.sections.forEach(s=>sections[s.id]=[]));

    // simple demo seed
    sections.coilConv.push(add('coilConv',11,'ready'));
    sections.blast.push(add('blast',12,'issue'));
    sections.p250HrcN15.push(add('p250HrcN15',13,'progress'));
    sections.p108HotN15.push(add('p108HotN15',14,'ready'));
    sections.ferg108HotN25.push(add('ferg108HotN25',16,'ready'));

    // thresholds (defaults 0)
    const thresholds = { gs:0, ferg:0, aba:0 };

    const moves = {};
    return { cards, sections, thresholds, moves };
  }
  let state = seed();

  /* ---------- Selection / Tabs ---------- */
  let selectMode=false; const selection=new Set();
  const tabs=document.querySelectorAll('.tab[data-tab]');
  const panels={ board:document.getElementById('panel-board'), charts:document.getElementById('panel-charts'), issues:document.getElementById('panel-issues'), log:document.getElementById('panel-log') };
  tabs.forEach(t=>t.addEventListener('click',()=>{ tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
    const dst=t.dataset.tab; if(dst){ Object.values(panels).forEach(p=>p.classList.remove('active')); panels[dst].classList.add('active');
      if(dst==='charts') updateCharts();
      if(dst==='issues') updateIssuesPanel();
      if(dst==='log') updateLogPanel();
    }}));

  const selectBtn=document.getElementById('selectModeBtn'), selCount=document.getElementById('selCount'), clearSelBtn=document.getElementById('clearSelBtn');
  selectBtn.onclick=()=>{ selectMode=!selectMode; updateSelectionUI(); applySelectionDecor(); };
  clearSelBtn.onclick=()=>{ selection.clear(); updateSelectionUI(); applySelectionDecor(); };
  function updateSelectionUI(){ selCount.textContent='Selected: '+selection.size; clearSelBtn.disabled=selection.size===0; selectBtn.classList.toggle('on',selectMode); }

  /* ---------- Add Cards ---------- */
  const addLocSel = document.getElementById('addLocSel');
  const addSecSel = document.getElementById('addSecSel');
  const addOneBtn = document.getElementById('addOneBtn');
  const addOneInput = document.getElementById('addOneInput');
  const batchStart = document.getElementById('batchStart');
  const batchEnd = document.getElementById('batchEnd');
  const batchReady = document.getElementById('batchReady');
  const batchBtn = document.getElementById('batchBtn');

  function populateAddSelectors(){
    addLocSel.innerHTML = '';
    CONFIG.forEach(loc=>{
      const opt=document.createElement('option');
      opt.value=loc.id; opt.textContent=loc.title;
      addLocSel.appendChild(opt);
    });
    addLocSel.value='gs';   // default to G&S
    refreshSectionsForSelectedLoc();
  }
  function refreshSectionsForSelectedLoc(){
    const locId = addLocSel.value;
    const loc = CONFIG.find(l=>l.id===locId);
    addSecSel.innerHTML='';
    (loc?.sections||[]).forEach(sec=>{
      const opt=document.createElement('option');
      opt.value=sec.id; opt.textContent=sec.title;
      addSecSel.appendChild(opt);
    });
    if(addSecSel.options.length){ addSecSel.selectedIndex=0; }
  }
  addLocSel.addEventListener('change', refreshSectionsForSelectedLoc);

  addOneBtn.onclick=()=>{ 
    const n=parseInt((addOneInput.value||'').trim(),10); 
    if(isNaN(n)) return alert('Enter a Card ID number.');
    const secId = addSecSel.value;
    if(!secId) return alert('Choose a section first.');
    upsertCardToSection(`${secId}-H${n}`,`Card ID ${n}`,secId,'empty'); 
    addOneInput.value=''; 
    render(); 
    saveSoon();
  };

  batchBtn.onclick=()=>{ 
    const s=parseInt(batchStart.value,10), e=parseInt(batchEnd.value,10), ready=batchReady.checked;
    const secId = addSecSel.value;
    if(!secId) return alert('Choose a section first.');
    if(isNaN(s)||isNaN(e)||e<s||s<0||e-s>5000) return alert('Enter a valid range (max 5000 cards).');
    for(let n=s;n<=e;n++){
      upsertCardToSection(`${secId}-H${n}`,`Card ID ${n}`,secId, ready?'ready':'empty');
    }
    render();
    saveSoon();
  };

  const wrap=document.getElementById('locations');

  function buildLocation(loc){
    const el=document.createElement('div'); el.className='location'; el.dataset.locId=loc.id;

    const header=document.createElement('div'); header.className='loc-header';

    const left=document.createElement('div'); left.className='loc-title'; left.textContent=loc.title;

    const tools=document.createElement('div'); tools.className='loc-tools';

    const lbl=document.createElement('span'); lbl.className='small'; lbl.textContent='Target';
    const input=document.createElement('input'); input.type='number'; input.min='0'; input.className='thresh';
    input.value = (state.thresholds && Number.isFinite(state.thresholds[loc.id])) ? state.thresholds[loc.id] : 0;
    input.dataset.locThresh = loc.id;
    input.onchange = () => {
      const v = parseInt(input.value,10);
      if(!state.thresholds) state.thresholds = {};
      state.thresholds[loc.id] = Number.isFinite(v) && v>=0 ? v : 0;
      saveSoon(); render();
    };

    const ind=document.createElement('span'); ind.className='loc-ind'; ind.dataset.locInd=loc.id; ind.title='Target status';
    const total=document.createElement('div'); total.className='badge'; total.dataset.locCount=loc.id; total.textContent='0';

    tools.append(lbl,input,ind,total);
    header.append(left,tools);

    const sections=document.createElement('div'); sections.className='sections';
    loc.sections.forEach(s=>sections.appendChild(buildSection(loc,s)));
    el.append(header,sections); return el;
  }

  function buildSection(loc, sec){
    const el=document.createElement('div'); el.className='section'; el.dataset.sectionId=sec.id; el.dataset.locId=loc.id;

    const header=document.createElement('div'); header.className='section-header';
    const title=document.createElement('div'); title.className='section-title'; title.textContent=sec.title;
    const actions=document.createElement('div'); actions.className='section-actions';
    const clearBtn=document.createElement('button'); clearBtn.className='btn muted'; clearBtn.textContent='Clear Section'; clearBtn.onclick=()=>clearSection(sec.id);
    const makeAllReady=document.createElement('button'); makeAllReady.className='btn secondary'; makeAllReady.textContent='Make All Ready'; makeAllReady.onclick=()=>setSectionStatus(sec.id,'ready');
    const count=document.createElement('div'); count.className='badge'; count.dataset.secCount=sec.id; count.textContent='0';
    actions.append(clearBtn,makeAllReady,count); header.append(title,actions);

    const list=document.createElement('div'); list.className='list'; list.dataset.listFor=sec.id;
    enableDrop(el); enableDrop(list);
    el.append(header,list); return el;

    function enableDrop(target){
      target.addEventListener('dragover',e=>{ e.preventDefault(); el.classList.add('drop-target') });
      target.addEventListener('dragleave',()=> el.classList.remove('drop-target'));
      target.addEventListener('drop',e=>{
        e.preventDefault(); el.classList.remove('drop-target');
        const firstId=e.dataTransfer.getData('text/plain');
        const group=(window.__dragGroup&&window.__dragGroup.length)?Array.from(new Set(window.__dragGroup)):(firstId?[firstId]:[]);
        if(group.length) moveGroup(group,sec.id); window.__dragGroup=null;
      });
    }
  }

  function buildTile(card){
    const el=document.createElement('div'); el.className='tile '+(card.status||'empty'); el.draggable=true; el.id=card.id; el.title=card.title;
    if(selection.has(card.id)) el.classList.add('selected');
    el.addEventListener('dragstart',e=>{ el.classList.add('dragging'); const group=selection.has(card.id)?Array.from(selection):[card.id]; window.__dragGroup=group; e.dataTransfer.setData('text/plain',card.id); e.dataTransfer.effectAllowed='move'; });
    el.addEventListener('dragend',()=> el.classList.remove('dragging'));
    el.addEventListener('click',e=>{ if(selectMode||e.ctrlKey||e.metaKey){ toggleSelect(card.id); } else { 
      const order=['ready','issue','progress','empty']; 
      const cur=state.cards[card.id].status||'empty'; 
      state.cards[card.id].status=order[(order.indexOf(cur)+1)%order.length]; 
      saveSoon(); render(); }});
    const x=document.createElement('div'); x.textContent='×'; x.className='x'; x.onclick=e=>{ e.stopPropagation(); deleteCard(card.id) }; el.appendChild(x);
    return el;
  }

  function upsertCardToSection(id,title,sectionId,status){
    if(!state.cards[id]) state.cards[id]={id,title,status}; else { state.cards[id].title=title; if(status) state.cards[id].status=status; }
    Object.keys(state.sections).forEach(k=>{ state.sections[k]=(state.sections[k]||[]).filter(x=>x!==id); });
    (state.sections[sectionId] ||= []).push(id); saveSoon();
  }
  function setSectionStatus(sectionId,status){ (state.sections[sectionId]||[]).forEach(id=>{ if(state.cards[id]) state.cards[id].status=status; }); saveSoon(); render(); }
  function clearSection(sectionId){ const ids=state.sections[sectionId]||[]; if(!ids.length||!confirm('Delete all cards in this section?')) return; ids.forEach(id=> delete state.cards[id]); state.sections[sectionId]=[]; saveSoon(); render(); }

  /* Move group + log */
  function moveGroup(ids,dst){ 
    const prevById={};
    for(const [secId, arr] of Object.entries(state.sections)){ for(const cid of arr){ if(ids.includes(cid)) prevById[cid]=secId; } }
    Object.keys(state.sections).forEach(k=>{ state.sections[k]=(state.sections[k]||[]).filter(id=>!ids.includes(id)); });
    (state.sections[dst] ||= []).push(...ids); 

    const today = new Date();
    const day = today.toISOString().slice(0,10);
    state.moves = state.moves || {};
    state.moves[day] = state.moves[day] || {};
    for(const cid of ids){
      const from = prevById[cid];
      if(from && from !== dst){
        const key = from + '|' + dst;
        state.moves[day][key] = (state.moves[day][key] || 0) + 1;
      }
    }

    selection.clear(); saveSoon(); render(); 
  }

  function deleteCard(id){ Object.keys(state.sections).forEach(k=>{ state.sections[k]=(state.sections[k]||[]).filter(x=>x!==id); }); delete state.cards[id]; selection.delete(id); saveSoon(); render(); }

  function render(){
    if(!wrap.dataset.built){ wrap.innerHTML=''; CONFIG.forEach(loc=>wrap.appendChild(buildLocation(loc))); wrap.dataset.built='1'; }

    CONFIG.forEach(loc=>{
      let locTotal=0;

      const tInput = wrap.querySelector(`[data-loc-thresh="${loc.id}"]`);
      if(tInput && state.thresholds && Number.isFinite(state.thresholds[loc.id])) {
        tInput.value = state.thresholds[loc.id];
      }

      loc.sections.forEach(sec=>{
        const list=wrap.querySelector(`[data-list-for="${sec.id}"]`);
        if(list){ list.innerHTML=''; (state.sections[sec.id]||[]).forEach(id=>{ const card=state.cards[id]; if(card) list.appendChild(buildTile(card)); }); }
        const c=wrap.querySelector(`[data-sec-count="${sec.id}"]`);
        const cnt=(state.sections[sec.id]||[]).length;
        if(c) c.textContent=String(cnt);

        // Do NOT count "Unused" sections toward location total
        const isUnused = /Unused$/i.test(sec.id) || /^SAES\s+Unused\b/i.test(sec.title);
        if(!isUnused) locTotal+=cnt;
      });

      const lc=wrap.querySelector(`[data-loc-count="${loc.id}"]`);
      if(lc) lc.textContent=String(locTotal);

      const ind=wrap.querySelector(`[data-loc-ind="${loc.id}"]`);
      const threshold = (state.thresholds && Number.isFinite(state.thresholds[loc.id])) ? state.thresholds[loc.id] : 0;
      if(ind){
        ind.classList.remove('good','bad');
        const ok = locTotal >= threshold;
        ind.classList.add(ok?'good':'bad');
        ind.textContent = ok ? 'OK' : 'Below';
        ind.title = `Total (excl. Unused) ${locTotal} vs target ${threshold}`;
      }
    });

    applySelectionDecor();
    if(document.getElementById('panel-charts').classList.contains('active')) updateCharts();
    if(document.getElementById('panel-issues').classList.contains('active')) updateIssuesPanel();
    if(document.getElementById('panel-log').classList.contains('active')) updateLogPanel();
  }

  function applySelectionDecor(){ document.querySelectorAll('.tile').forEach(t=> t.classList.toggle('selected', selection.has(t.id))); }
  function toggleSelect(id){ if(selection.has(id)) selection.delete(id); else selection.add(id); updateSelectionUI(); applySelectionDecor(); }

  /* Marquee selection */
  let marqueeEl=null, marqueeStart=null, marqueeAppend=false, marqueeSeed=[];
  const boardPanel=document.getElementById('panel-board');
  boardPanel.addEventListener('mousedown',e=>{
    if(!(selectMode||e.shiftKey)) return; if(e.button!==0) return; if(e.target.closest('.tile')) return;
    marqueeAppend=e.ctrlKey||e.metaKey; marqueeSeed=Array.from(selection);
    if(!marqueeAppend) selection.clear(); applySelectionDecor();
    marqueeStart={x:e.clientX,y:e.clientY}; marqueeEl=document.createElement('div'); marqueeEl.className='marquee'; boardPanel.appendChild(marqueeEl);
    const onMove=ev=>{ updateMarquee(ev.clientX,ev.clientY); applySelectionDecor(); };
    const onUp=()=>{ document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp);
      if(marqueeEl){ marqueeEl.remove(); marqueeEl=null; } marqueeStart=null; saveSoon(); };
    document.addEventListener('mousemove',onMove); document.addEventListener('mouseup',onUp); e.preventDefault();
  });
  function updateMarquee(x,y){
    if(!marqueeEl||!marqueeStart) return;
    const rB=boardPanel.getBoundingClientRect(); const L=Math.min(x,marqueeStart.x), R=Math.max(x,marqueeStart.x), T=Math.min(y,marqueeStart.y), B=Math.max(y,marqueeStart.y);
    marqueeEl.style.left=(L-rB.left+boardPanel.scrollLeft)+'px'; marqueeEl.style.top=(T-rB.top+boardPanel.scrollTop)+'px';
    marqueeEl.style.width=(R-L)+'px'; marqueeEl.style.height=(B-T)+'px';
    const hits=[]; document.querySelectorAll('.tile').forEach(t=>{ const r=t.getBoundingClientRect(); const ok=!(r.right<L||r.left>R||r.bottom<T||r.top>B); if(ok) hits.push(t.id); });
    selection.clear(); if(marqueeAppend) marqueeSeed.forEach(id=>selection.add(id)); hits.forEach(id=>selection.add(id));
  }

  /* ---------- Charts ---------- */
  const paletteSections = ['#0ea5e9','#a78bfa','#ef4444','#22c55e','#f59e0b','#14b8a6','#8b5cf6','#f43f5e','#10b981','#eab308'];
  const paletteLocations = { GS:'#10b981', FERG:'#f59e0b', ABA:'#2563eb' };

  function updateCharts(){
    const locData = CONFIG.map(loc => ({
      key: loc.id,
      title: loc.title,
      total: loc.sections.reduce((sum, s) => sum + (state.sections[s.id]?.length || 0), 0)
    }));
    drawPie('chart-locations',
      locData.map(x => x.title),
      locData.map(x => x.total),
      [paletteLocations.GS, paletteLocations.FERG, paletteLocations.ABA],
      'legend-locations'
    );

    const gs = CONFIG.find(x=>x.id==='gs');
    drawPie('chart-gs',
      gs.sections.map(s => s.title),
      gs.sections.map(s => state.sections[s.id]?.length || 0),
      paletteSections,
      'legend-gs'
    );

    const ferg = CONFIG.find(x=>x.id==='ferg');
    drawPie('chart-ferg',
      ferg.sections.map(s => s.title),
      ferg.sections.map(s => state.sections[s.id]?.length || 0),
      paletteSections,
      'legend-ferg'
    );

    const aba = CONFIG.find(x=>x.id==='aba');
    drawPie('chart-aba',
      aba.sections.map(s => s.title),
      aba.sections.map(s => state.sections[s.id]?.length || 0),
      paletteSections,
      'legend-aba'
    );
  }

  function drawPie(canvasId, labels, values, colors, legendId){
    const canvas = document.getElementById(canvasId);
    const legend = document.getElementById(legendId);
    if(!canvas || !legend) return;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const total = values.reduce((a,b)=>a+b,0);
    const cx = canvas.width/2, cy = canvas.height/2;
    const radius = Math.min(canvas.width, canvas.height)/2 - 10;
    const inner = radius * 0.55;

    if(total === 0){
      ctx.fillStyle = '#e5e7eb';
      ctx.beginPath(); ctx.arc(cx, cy, radius, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#fff';
      ctx.beginPath(); ctx.arc(cx, cy, inner, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#64748b'; ctx.font='14px ui-sans-serif';
      const msg = 'No data';
      ctx.fillText(msg, cx - ctx.measureText(msg).width/2, cy + 5);
      legend.innerHTML = '';
      return;
    }

    let start = -Math.PI/2;
    values.forEach((v, i) => {
      const frac = v/total, angle = frac * Math.PI * 2;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, radius, start, start + angle);
      ctx.closePath();
      ctx.fillStyle = colors[i % colors.length];
      ctx.fill();
      start += angle;
    });

    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath(); ctx.arc(cx, cy, inner, 0, Math.PI*2); ctx.fill();
    ctx.globalCompositeOperation = 'source-over';

    ctx.fillStyle = '#0f172a';
    ctx.font = 'bold 18px ui-sans-serif';
    ctx.fillText(String(total), cx - ctx.measureText(String(total)).width/2, cy + 6);

    legend.innerHTML = '';
    labels.forEach((label, i) => {
      const row = document.createElement('div'); row.className='legend-item';
      const sw = document.createElement('span'); sw.className='legend-swatch'; sw.style.background = colors[i % colors.length];
      const txt = document.createElement('span');
      const v = values[i];
      const pct = total ? ((v/total)*100).toFixed(1) : '0.0';
      txt.textContent = `${label}: ${v} (${pct}%)`;
      row.append(sw, txt); legend.appendChild(row);
    });
  }

  /* ---------- Issues Tab ---------- */
  function cardToSectionMap(){
    const m = {};
    for(const [secId, arr] of Object.entries(state.sections||{})){ (arr||[]).forEach(id => m[id] = secId); }
    return m;
  }

  function updateIssuesPanel(){
    const tbl = document.getElementById('issuesTable');
    const totalEl = document.getElementById('issuesTotal');
    if(!tbl || !totalEl) return;

    tbl.querySelectorAll('.issues-row:not(.head)').forEach(n => n.remove());

    const idx = cardToSectionMap();
    const reds = Object.values(state.cards||{}).filter(c => c && c.status === 'issue');

    totalEl.textContent = String(reds.length);

    reds.sort((a,b)=>{
      const na = (a.title.match(/(\d+)/) || [0,0])[1];
      const nb = (b.title.match(/(\d+)/) || [0,0])[1];
      return (+na) - (+nb);
    });

    reds.forEach(card => {
      const sec = idx[card.id];
      const loc = SEC_TO_LOC[sec];
      const row = document.createElement('div'); row.className='issues-row';
      const cid = (card.title.match(/(\d+)/) || card.id.match(/H(\d+)/) || [,''])[1];

      const dCid = document.createElement('div'); dCid.textContent = cid || '';
      const dLoc  = document.createElement('div'); dLoc.textContent = LOC_TITLES[loc] || '';
      const dSec  = document.createElement('div'); dSec.textContent = SEC_TITLES[sec] || '';

      const input = document.createElement('input');
      input.className = 'issue-note';
      input.placeholder = 'Describe issue...';
      input.value = card.note || '';
      input.addEventListener('change', ()=> { state.cards[card.id].note = input.value; saveSoon(); });
      input.addEventListener('blur', ()=> { state.cards[card.id].note = input.value; saveSoon(); });

      const act = document.createElement('div');
      const btn = document.createElement('button'); btn.className='btn ok'; btn.textContent='Mark Ready';
      btn.onclick = ()=> { state.cards[card.id].status = 'ready'; saveSoon(); render(); };
      act.appendChild(btn);

      row.append(dCid, dLoc, dSec, input, act);
      tbl.appendChild(row);
    });
  }

  /* ---------- Log Tab ---------- */
  function computeLogRows(){
    const rows = [];
    const days = Object.keys(state.moves||{}).sort();
    for(const day of days){
      const pairs = state.moves[day];
      for(const key in pairs){
        const [from, to] = key.split('|');
        const cnt = pairs[key];
        const fromTxt = (SEC_TITLES[from]||from) + ' (' + (LOC_TITLES[SEC_TO_LOC[from]]||'') + ')';
        const toTxt   = (SEC_TITLES[to]||to)   + ' (' + (LOC_TITLES[SEC_TO_LOC[to]]||'') + ')';
        rows.push({date:day, from, to, fromTxt, toTxt, count:cnt});
      }
    }
    rows.sort((a,b)=> (a.date.localeCompare(b.date)) || a.fromTxt.localeCompare(b.fromTxt) || a.toTxt.localeCompare(b.toTxt) );
    return rows;
  }

  function updateLogPanel(){
    const body = document.getElementById('logBody');
    if(!body) return;
    body.innerHTML = '';
    const rows = computeLogRows();
    if(rows.length===0){
      const empty = document.createElement('div');
      empty.className='small';
      empty.style.margin='0 24px';
      empty.textContent = 'No moves yet.';
      body.appendChild(empty);
      return;
    }
    rows.forEach(r => {
      const row = document.createElement('div'); row.className='log-row';
      row.innerHTML = `<div>${r.date}</div><div>${r.fromTxt}</div><div>${r.toTxt}</div><div>${r.count}</div>`;
      body.appendChild(row);
    });
  }
/* Snapshot CSV (counts + IDs by section) */
function exportSnapshotCSV(){
  const rows = [['Location','Section','Count','CardIDs']];
  CONFIG.forEach(loc=>{
    loc.sections.forEach(sec=>{
      const ids = state.sections[sec.id] || [];
      const count = ids.length;
      const cardList = ids.map(id => (id.match(/H(\d+)/)||[])[1] || id).join(' ');
      rows.push([loc.title, sec.title, String(count), cardList]);
    });
  });
  const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `saes_snapshot_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
document.getElementById('exportSnapshotBtn')?.addEventListener('click', exportSnapshotCSV);

/* Init */
populateAddSelectors();
render();
})();
</script>

  /* Init */
  populateAddSelectors();
  render();
})();
</script>
</body>
</html>
